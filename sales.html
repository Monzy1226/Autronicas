<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Management | Autronicas</title>
  <link rel="stylesheet" href="sales.css" />
</head>
<body>
<header class="navbar">
  <div class="logo">Inventory Management System</div>
  <nav>
    <a href="dashboard.html"><strong>Dashboard</strong></a>
    <a href="inventory.html"><strong>Inventory</strong></a>
    <a href="sales.html" class="active"><strong>Sales</strong></a>
    <a href="login.html"><strong>Logout</strong></a>
  </nav>
</header>

<main class="container fade-in">

  <div class="cards">
  <div class="card">
    <h4>Daily Summary Report</h4>
    <p>Total Sales: ₱<span id="dailyTotal">0.00</span></p>
  </div>

  <div class="card">
    <h4>View Sales by Date</h4>
    <input type="date" id="viewSalesDate" />
    <p>Showing sales for: <span id="selectedDate"></span></p>
    <p>Total Sales: ₱<span id="salesByDateTotal">0.00</span></p>
  </div>

  <div class="card">
    <h4>Sales by Date Range</h4>
    <label>Start: <input type="date" id="startDate" /></label>
    <label>End: <input type="date" id="endDate" /></label>
    <p>Total: ₱<span id="salesByRangeTotal">0.00</span></p>
  </div>
</div>

  <div class="top-bar">
    <h2>Sales Management</h2>
    <button id="addSaleBtn" class="btn-add">＋ Add Sale</button>
  </div>

  <h3>Sales Log</h3>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Sale #</th>
        <th>Product Code</th>
        <th>Category</th>
        <th>Description</th>
        <th>Qty</th>
        <th>Unit Price</th>
        <th>Total</th>
        <th>Amount Paid</th>
        <th>Balance</th>
        <th>Status</th>
        <th>Sold To</th>
        <th>Remarks</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="salesTableBody"></tbody>
  </table>
</main>

<!-- Add/Edit Sale Modal -->
<div id="saleModal" class="modal hidden">
  <div class="modal-content slide-up">
    <h2 id="modalTitle">Add Sale</h2>
    <input type="text" id="saleCode" placeholder="Product Code" />
    <input type="number" id="saleQty" placeholder="Quantity" />
    <select id="priceType">
      <option value="" disabled selected>Select Price Type</option>
      <option value="srpPrivate">Private</option>
      <option value="srpLGU">LGU</option>
    </select>
    <input type="number" id="saleDiscount" placeholder="Discount %" />
    <input type="number" id="amountPaid" placeholder="Amount Paid (₱)" />
    <input type="text" id="saleBuyer" placeholder="Sold To" />
    <input type="text" id="saleRemarks" placeholder="Remarks" />
    <button id="confirmSale" class="btn-primary">Confirm</button>
    <button id="closeModal" class="btn-secondary">Cancel</button>
  </div>
</div>

<script>
let sales = JSON.parse(localStorage.getItem('sales')) || [];
let inventory = JSON.parse(localStorage.getItem('inventoryAll')) || [];
let editingSaleNo = null;

const salesTableBody = document.getElementById('salesTableBody');
const saleModal = document.getElementById('saleModal');
const confirmSaleBtn = document.getElementById('confirmSale');
const addSaleBtn = document.getElementById('addSaleBtn');
const closeModal = document.getElementById('closeModal');
const dailyTotalEl = document.getElementById('dailyTotal');

/* ===== RENDER SALES ===== */
function renderSales(filteredSales = null) {
  const data = filteredSales || sales;
  salesTableBody.innerHTML = '';

  data.forEach((sale) => {
    const balance = sale.totalAmount - sale.amountPaid;
    const status = balance <= 0
      ? "<span style='color:green;'>Completed</span>"
      : "<span style='color:orange;'>Partial</span>";

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${sale.date}</td>
      <td>${sale.saleNo}</td>
      <td>${sale.productCode}</td>
      <td>${sale.category}</td>
      <td>${sale.description}</td>
      <td>${sale.quantity}</td>
      <td>₱${sale.unitPrice.toFixed(2)}</td>
      <td>₱${sale.totalAmount.toFixed(2)}</td>
      <td>₱${sale.amountPaid.toFixed(2)}</td>
      <td>₱${balance.toFixed(2)}</td>
      <td>${status}</td>
      <td>${sale.soldTo}</td>
      <td>${sale.remarks}</td>
      <td>
        ${balance > 0 ? `<button class="edit-btn" data-sale-no="${sale.saleNo}">✏️ Edit</button>` : ''}
      </td>
    `;
    salesTableBody.appendChild(tr);
  });

  const total = data.reduce((sum, s) => sum + s.totalAmount, 0);
  dailyTotalEl.textContent = total.toFixed(2);

  attachButtons();
}

/* ===== ADD SALE ===== */
addSaleBtn.onclick = () => {
  editingSaleNo = null;
  document.getElementById('modalTitle').textContent = "Add Sale";
  ['saleCode','saleQty','priceType','saleDiscount','amountPaid','saleBuyer','saleRemarks']
    .forEach(id => document.getElementById(id).value = '');
  confirmSaleBtn.textContent = "Confirm";
  saleModal.classList.remove('hidden');
};

closeModal.onclick = () => saleModal.classList.add('hidden');

/* ===== SAVE / EDIT ===== */
confirmSaleBtn.onclick = () => {
  const code = document.getElementById('saleCode').value.trim();
  const qty = parseInt(document.getElementById('saleQty').value);
  const priceType = document.getElementById('priceType').value;
  const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
  const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
  const buyer = document.getElementById('saleBuyer').value.trim();
  const remarks = document.getElementById('saleRemarks').value.trim();

  if (!code || !qty || qty <= 0 || !priceType) return alert("Please fill all fields.");

  const product = inventory.find(p => p.code === code);
  if (!product) return alert("Product not found.");
  if (qty > product.quantity && !editingSaleNo) return alert("Not enough stock!");

  const date = new Date().toLocaleDateString('en-CA');
  const unitPrice = product[priceType];
  const subtotal = unitPrice * qty;
  const discountedTotal = subtotal - (subtotal * (discount / 100));
  const balance = discountedTotal - paid;

  if (editingSaleNo) {
    const index = sales.findIndex(s => s.saleNo === editingSaleNo);
    if (index !== -1) {
      const old = sales[index];
      const oldBalance = old.totalAmount - old.amountPaid;

      if (oldBalance <= 0) {
        alert("This sale is fully paid and cannot be edited.");
        saleModal.classList.add('hidden');
        return;
      }

      // Update price type, unit price, and recalc totals
      old.unitPrice = unitPrice;
      old.totalAmount = discountedTotal;
      old.amountPaid = paid;
      old.discount = discount;
      old.soldTo = buyer;
      old.remarks = remarks;

      sales[index] = old;
    }
  } else {
    const saleNo = 'S' + Date.now();
    const newSale = {
      date, saleNo,
      productCode: code,
      category: product.category,
      description: product.description,
      quantity: qty,
      unitPrice,
      discount,
      totalAmount: discountedTotal,
      amountPaid: paid,
      soldTo: buyer,
      remarks
    };
    sales.push(newSale);

    const productIndex = inventory.findIndex(p => p.code === code);
    if (productIndex !== -1) {
      inventory[productIndex].quantity -= qty;
      if (inventory[productIndex].quantity < 0) inventory[productIndex].quantity = 0;
      localStorage.setItem('inventoryAll', JSON.stringify(inventory));
    }
  }

  localStorage.setItem('sales', JSON.stringify(sales));
  saleModal.classList.add('hidden');
  editingSaleNo = null;
  renderSales();
};

/* ===== ATTACH BUTTONS ===== */
function attachButtons() {
  document.querySelectorAll('.edit-btn').forEach(btn =>
    btn.addEventListener('click', () => {
      const saleNo = btn.getAttribute('data-sale-no');
      const sale = sales.find(s => s.saleNo === saleNo);
      if (!sale) return;

      const balance = sale.totalAmount - sale.amountPaid;
      if (balance <= 0) {
        alert("This sale is fully paid and cannot be edited.");
        return;
      }

      document.getElementById('saleCode').value = sale.productCode;
      document.getElementById('saleQty').value = sale.quantity;
      document.getElementById('priceType').value =
        sale.unitPrice === (inventory.find(p => p.code === sale.productCode)?.srpLGU) ? 'srpLGU' : 'srpPrivate';
      document.getElementById('saleDiscount').value = sale.discount;
      document.getElementById('amountPaid').value = sale.amountPaid;
      document.getElementById('saleBuyer').value = sale.soldTo;
      document.getElementById('saleRemarks').value = sale.remarks;

      document.getElementById('modalTitle').textContent = "Edit Sale";
      confirmSaleBtn.textContent = "Save Changes";
      editingSaleNo = sale.saleNo;
      saleModal.classList.remove('hidden');
    })
  );
}

/* ===== FILTER SALES ===== */
document.getElementById('viewByDate').onclick = () => {
  const filterDate = document.getElementById('filterDate').value;
  if (!filterDate) return alert("Select a date.");
  const filtered = sales.filter(s => s.date === filterDate);
  renderSales(filtered);
};

document.getElementById('viewByRange').onclick = () => {
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  if (!start || !end) return alert("Select both start and end dates.");
  const filtered = sales.filter(s => s.date >= start && s.date <= end);
  renderSales(filtered);
};

document.getElementById('clearFilter').onclick = () => renderSales();

renderSales();
</script>
</body>
</html>
